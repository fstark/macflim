name: Build macOS (x86_64)

on:
  push:
    branches: [ main, generators ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos-x86:
    runs-on: macos-13
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        brew install ffmpeg
        brew install yt-dlp
        brew install imagemagick
      
    - name: Build flimmaker
      run: |
        cd src
        make clean
        make release
        
        # Ad-hoc code sign the binary
        codesign -s - -f ../flimmaker
        
        # Show binary info
        file ../flimmaker
        codesign -dv ../flimmaker
    
    - name: Package with bundled libraries
      run: |
        # Create directory structure
        mkdir -p macflim/bin/lib
        
        # Copy the binary
        cp flimmaker macflim/bin/
        
        # Detect what libraries the binary actually needs and copy them
        BREW_PREFIX=$(brew --prefix)
        echo "=== Libraries referenced by flimmaker ==="
        otool -L flimmaker | grep -v ":" | grep -v "/usr/lib" | grep -v "@rpath" || true
        
        # Copy all libraries referenced by the binary
        otool -L flimmaker | grep -v ":" | grep -v "/usr/lib" | grep -v "@rpath" | awk '{print $1}' | while read lib; do
          if [ -f "$lib" ]; then
            cp "$lib" macflim/bin/lib/
          fi
        done
        
        # Copy GCC C++ standard library (these use @rpath already)
        GCC_LIB=$(brew --prefix gcc@14)/lib/gcc/14
        cp "$GCC_LIB/libstdc++".*.dylib macflim/bin/lib/ || true
        cp "$GCC_LIB/libgcc_s".*.dylib macflim/bin/lib/ || true
        
        # Copy dependencies of bundled libraries
        for dylib in macflim/bin/lib/*.dylib; do
          otool -L "$dylib" 2>/dev/null | grep -v ":" | grep -v "/usr/lib" | grep -v "@rpath" | awk '{print $1}' | while read dep; do
            depname=$(basename "$dep")
            if [ -f "$dep" ] && [ ! -f "macflim/bin/lib/$depname" ]; then
              cp "$dep" macflim/bin/lib/ || true
            fi
          done
        done
        
        # Now fix all the paths in the binary - detect actual paths and replace them
        echo "=== Fixing library paths in flimmaker ==="
        install_name_tool -add_rpath "@executable_path/lib" macflim/bin/flimmaker || true
        otool -L macflim/bin/flimmaker | grep -v ":" | grep -v "/usr/lib" | grep -v "@rpath" | awk '{print $1}' | while read oldpath; do
          libname=$(basename "$oldpath")
          if [ -f "macflim/bin/lib/$libname" ]; then
            echo "  Changing $oldpath -> @rpath/$libname"
            install_name_tool -change "$oldpath" "@rpath/$libname" macflim/bin/flimmaker || true
          fi
        done
        
        # Fix paths in all bundled dylibs
        for dylib in macflim/bin/lib/*.dylib; do
          chmod +w "$dylib"
          # Update id
          install_name_tool -id "@rpath/$(basename $dylib)" "$dylib" || true
          # Update dependencies
          otool -L "$dylib" 2>/dev/null | grep -v ":" | grep -v "/usr/lib" | grep -v "@rpath" | awk '{print $1}' | while read dep; do
            depname=$(basename "$dep")
            if [ -f "macflim/bin/lib/$depname" ]; then
              install_name_tool -change "$dep" "@rpath/$depname" "$dylib" || true
            fi
          done
        done
      
    - name: Verify build
      run: |
        ls -lh macflim/bin/flimmaker
        ls -lh macflim/bin/lib/
        otool -L macflim/bin/flimmaker
        echo "=== Testing flimmaker binary ==="
        ./macflim/bin/flimmaker --help
        echo "=== Binary test completed successfully ==="
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macflim-macos-x86_64-${{ github.sha }}
        path: macflim/
        retention-days: 30
